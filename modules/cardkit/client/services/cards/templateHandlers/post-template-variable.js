// e.g. loadCardPosts('[data-post-template]', 'Aaron Harris');

window.loadCardPosts = function(container, client, posts) {
    if (!container || !client) return;

    var $container = $(container);
    $container.find('.autogenerated,.placeholder').remove();

    var template = ($container.find('.template').html() || '').trim();
    var cardUrl = $container.attr('data-post-template') || '';

    var pageUrl = $container.attr('data-post-page');
    if (pageUrl) pageUrl = pageUrl.replace(/^https?:\/\/[^\/]+/i, '');

    var postCategory = $container.attr('data-post-category');
    if ((postCategory || '').toLowerCase() == 'ALL') postCategory = undefined;

    var order = $container.attr('data-post-order');

    var api = '';
    if (!(api = $container.attr('data-post-api'))) {
        $container.attr('data-post-api', api = window.location.origin);
    }

    cardUrl = cardUrl.replace(/{{.+}}/g, '').trim();
    if (!cardUrl && !template) return;

    var cardRequest = cardUrl
        ? $.ajax({
            type: 'GET',
            url: api + '/cards/json/' + client + '/' + cardUrl,
            dataType: "json",
            cache: false
        })
        : $.when([{ 'Html Markup': template }]);

    var postsUrl = api + '/posts/json/' + client;
    var singlePost = $container.attr('data-single') == 'true';
    var id = singlePost ? (window.location.pathname.match(/\/id([^\/]+)/i) || [])[1] : undefined;
    if (id) postsUrl += '?id=' + id;

    var postsRequest = posts ? $.Deferred.resolve([{ posts: posts }]) : $.ajax({
        type: 'GET',
        url: postsUrl,
        data: {
            category: postCategory
        },
        dataType: "json",
        cache: false
    });

    return $.when(cardRequest, postsRequest).then(function(cardResponse, postsResponse) {
        var card = cardResponse[0] || {};
        var posts = postsResponse[0].posts || [];

        posts = _.sortBy(posts, function(post) {
            if (order == 'Chronological') return moment(post.published).unix();
            return -moment(post.published).unix(); // default
        });

        var template = card['Html Markup'] || '';

        if (card.css) $(document.createElement('style')).html(card.css).appendTo($container);

        posts.forEach(function(post) {
            var id = (post._id || '').toString();

            var html = template
                .replace(paramBinding('id'), id)
                .replace(paramBinding('title'), post.title || '')
                .replace(paramBinding('date'), post.formattedDate || '')
                .replace(paramBinding('time'), post.formattedTime || '')
                .replace(paramBinding('dateISO'), post.dateISO || '')
                .replace(paramBinding('timeISO'), post.timeISO || '')
                .replace(paramBinding('author'), post.author && post.author.displayName || '')
                .replace(paramBinding('description'), (singlePost ? post.content : post.excerpt) || '')
                .replace(paramBinding('description_excerpt'), post.excerpt || '')
                .replace(paramBinding('description_full'), post.content || '')
                .replace(paramBinding('image'), (post.featuredImage || {}).url || '')
                .replace(paramBinding('link'), pageUrl && id ? (pageUrl + '/id' + id) : '')
                .replace(paramBinding('categories'), _.compact(post.categories).join(','));

            $('<div>').html(html).contents().addClass('autogenerated').unwrap().appendTo($container);
        });
    });

    function paramBinding(name) {
        return new RegExp('[{\\[]+' + _.escapeRegex(name) + '[}\\]]+', 'gi');
    }
};
